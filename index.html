<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>DizzyGlitch</title>
<style>
  html,body{height:100%;margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,sans-serif}
  #stage{position:fixed;inset:0}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}
  .fade-in{animation:fi .65s ease-out forwards;opacity:0}
  .fade-out{animation:fo .65s ease-in forwards;opacity:1}
  @keyframes fi{to{opacity:1}} @keyframes fo{to{opacity:0}}

  #overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.86);color:#fff;z-index:10;padding:24px}
  #card{max-width:640px;text-align:center}
  h1{margin:0 0 10px;font-size:22px}
  p{margin:0 0 14px;opacity:.9;line-height:1.35}
  input{
    width:min(520px, 92vw);
    padding:12px 14px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(0,0,0,.35);
    color:#fff;
    font-size:16px;
    outline:none;
  }
  button{background:#fff;color:#000;border:0;border-radius:12px;padding:12px 14px;font-weight:700;margin-top:10px}
  #small{margin-top:10px;font-size:12px;opacity:.75}

  #hud{position:fixed;left:12px;right:12px;bottom:12px;display:flex;gap:10px;justify-content:space-between;z-index:5;pointer-events:none}
  .pill{padding:8px 10px;border-radius:999px;background:rgba(0,0,0,.45);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
        color:rgba(255,255,255,.78);font-size:12px;max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
</style>
</head>
<body>
<div id="stage"></div>

<div id="overlay">
  <div id="card">
    <h1>DizzyGlitch</h1>
    <p>
      Type a word/phrase (optional). It channel-flips through a built-in set of Internet Archive public-domain items.
      Uses the smallest “512KB MPEG4” file when available.
    </p>
    <input id="q" placeholder='Try: "night", "noir", "bus", "short", "avant", "comedy"' autocomplete="off" />
    <button id="start">Tap to Start</button>
    <div id="small">iOS needs a tap. Videos are muted + inline.</div>
  </div>
</div>

<div id="hud" aria-hidden="true">
  <div class="pill" id="status">ready</div>
  <div class="pill" id="now">—</div>
</div>

<script>
  // Built-in channels (all show “512KB MPEG4 download” on their item pages)
  // We'll resolve the actual file name via the IA Metadata API: https://archive.org/metadata/:identifier
  // (so we don’t guess filenames).   [oai_citation:1‡Internet Archive Blogs](https://blog.archive.org/2013/07/04/metadata-api/)
  const CHANNELS = [
    { id: "Oh_Mr.Porter_1937", title: "Oh, Mr. Porter! (1937)", tags: ["comedy","british","train","fog","night"] },
    { id: "He_Walked_by_Night_1948", title: "He Walked by Night (1948)", tags: ["noir","night","police","city","dark"] },
    { id: "Friday_the_Thirteenth_1933", title: "Friday the Thirteenth (1933)", tags: ["bus","british","drama","crash","dark"] },
    { id: "RomanceSentimentale", title: "Romance Sentimentale (1930)", tags: ["short","avant","experimental","surreal","mood"] },
  ];

  // Always-works fallback
  const FALLBACK = {
    title: "Fallback (CC0 flower.mp4)",
    url: "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4",
    tags: ["demo"]
  };

  const stage = document.getElementById("stage");
  const statusEl = document.getElementById("status");
  const nowEl = document.getElementById("now");
  const qEl = document.getElementById("q");

  let current = null;
  let running = false;
  let playable = []; // resolved {title,url,tags}

  const randInt = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
  const randFloat = (min,max)=>Math.random()*(max-min)+min;

  function tokenize(s){
    return (s||"")
      .toLowerCase()
      .replace(/[^a-z0-9\s']/g," ")
      .split(/\s+/)
      .filter(Boolean)
      .slice(0, 18);
  }

  function score(item, tokens){
    if (!tokens.length) return 1;
    const hay = (item.tags.join(" ") + " " + item.title).toLowerCase();
    let hits = 0;
    for (const t of tokens){
      if (t.length < 3) continue;
      if (hay.includes(t)) hits++;
    }
    return hits;
  }

  function pickClip(tokens){
    const base = playable.length ? playable : [FALLBACK];
    const scored = base
      .map(x => ({x, s: score(x, tokens)}))
      .filter(o => tokens.length ? o.s > 0 : true);

    const pool = scored.length ? scored : base.map(x => ({x, s: 1}));

    const total = pool.reduce((a,b)=>a + (b.s || 1), 0);
    let r = Math.random() * total;
    for (const o of pool){
      r -= (o.s || 1);
      if (r <= 0) return o.x;
    }
    return pool[pool.length - 1].x;
  }

  function makeVideo(src){
    const v = document.createElement("video");
    v.src = src;
    v.muted = true;
    v.playsInline = true;
    v.autoplay = true;
    v.preload = "auto";
    return v;
  }

  async function swapTo(item){
    const v = makeVideo(item.url);

    v.onerror = async () => {
      statusEl.textContent = "source error → skipping";
      // remove bad clip from pool so we don’t keep selecting it
      playable = playable.filter(p => p.url !== item.url);
      await swapTo(playable.length ? pickClip(tokenize(qEl.value)) : FALLBACK);
    };

    v.addEventListener("loadedmetadata", () => {
      const dur = Number.isFinite(v.duration) ? v.duration : 0;
      if (dur > 4){
        try { v.currentTime = randFloat(0, Math.max(0, dur - 2)); } catch {}
      }
    }, {once:true});

    if (!current){
      stage.appendChild(v);
      current = v;
    } else {
      v.classList.add("fade-in");
      current.classList.add("fade-out");
      stage.appendChild(v);
      const old = current;
      current = v;
      setTimeout(()=>{ try{old.pause()}catch{} old.remove(); }, 750);
    }

    nowEl.textContent = item.title;
    try { await v.play(); } catch {}
  }

  function startMicroCuts(){
    // stitchy / glitch vibe
    const tick = () => {
      if (!running || !current) return;
      const dur = Number.isFinite(current.duration) ? current.duration : 0;
      if (dur > 4){
        try { current.currentTime = randFloat(0, Math.max(0, dur - 1.5)); } catch {}
      }
      setTimeout(tick, randInt(250, 1200));
    };
    setTimeout(tick, randInt(250, 1200));
  }

  async function resolveIAItem(channel){
    // IA Metadata API returns JSON for an item: https://archive.org/metadata/:identifier
    const metaUrl = `https://archive.org/metadata/${encodeURIComponent(channel.id)}`;
    const res = await fetch(metaUrl, { headers: { "Accept": "application/json" } });
    if (!res.ok) throw new Error("metadata fetch failed");
    const data = await res.json();
    const files = Array.isArray(data.files) ? data.files : [];

    // Prefer the tiniest “512KB MPEG4” derivative if present
    // (Item pages show this option exists for these IDs.)  [oai_citation:2‡Internet Archive](https://archive.org/details/Oh_Mr.Porter_1937)
    let f = files.find(x => (x.format || "").toLowerCase().includes("512kb mpeg4"));
    if (!f) f = files.find(x => (x.name || "").toLowerCase().includes("512kb") && (x.name || "").toLowerCase().endsWith(".mp4"));
    if (!f) f = files.find(x => (x.format || "").toLowerCase().includes("mpeg4") && (x.name || "").toLowerCase().endsWith(".mp4"));

    if (!f || !f.name) throw new Error("no mp4 found");

    const url = `https://archive.org/download/${encodeURIComponent(channel.id)}/${encodeURIComponent(f.name)}`;
    return { title: channel.title, url, tags: channel.tags };
  }

  async function loadChannels(){
    statusEl.textContent = "loading channels…";
    const out = [];
    for (const ch of CHANNELS){
      try{
        const item = await resolveIAItem(ch);
        out.push(item);
      } catch (e){
        // skip quietly
      }
    }
    playable = out;
    statusEl.textContent = playable.length ? `channels ready (${playable.length})` : "no channels → fallback only";
  }

  async function loop(){
    if (!running) return;
    const tokens = tokenize(qEl.value);
    const clip = pickClip(tokens);
    await swapTo(clip);
    setTimeout(loop, randInt(2500, 9000));
  }

  document.getElementById("start").onclick = async () => {
    document.getElementById("overlay").remove();
    running = true;
    startMicroCuts();
    await loadChannels();
    await loop();
  };
</script>
</body>
</html>
